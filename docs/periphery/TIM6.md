# TIM6 - Базовый таймер STM32

## Общее описание

TIM6 (Timer 6) - это базовый таймер в микроконтроллерах STM32, относящийся к категории **базовых таймеров**. Он представляет собой самый простой представитель семейства таймеров и может быть рассмотрен как точный цифровой секундомер, основная задача которого — создавать периодические временные метки.

## Архитектура и особенности

### Особенности TIM6:
- **Простота**: TIM6 имеет минимальный набор функций по сравнению с таймерами TIM2-TIM5
- **Ограниченные возможности**: Не поддерживает генерацию выходных сигналов, только счет
- **Встроенный предделитель**: Имеет встроенный предделитель частоты
- **Прерывания**: Поддерживает прерывания по переполнению
- **Регистры**: Основные регистры доступны для программного управления

### Сравнение с другими таймерами:
| Таймер | Управление выходами | Предделитель | Прерывания | Счетчик |
|--------|-------------------|--------------|------------|---------|
| TIM6   | ❌                | ✅           | ✅         | ✅      |
| TIM2-TIM5 | ✅              | ✅           | ✅         | ✅      |

## Регистры таймера TIM6

### Основные регистры:

#### 1. CR1 (Control Register 1)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | ARPE     | Auto-reload preload enable |
| 6   | CMS      | Center-aligned mode selection |
| 5   | DIR      | Direction |
| 4   | OPM      | One-pulse mode |
| 3   | URS      | Update request source |
| 2   | UDIS     | Update disable |
| 1   | CEN      | Counter enable |

#### 2. CR2 (Control Register 2)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | TI1S     | TI1 selection |
| 6   | MMS      | Master mode selection |
| 5   | CCDS     | Capture/compare DMA selection |
| 4   | CCUS     | Capture/compare update selection |
| 3   | CCPC     | Capture/compare pre-load control |
| 2-0 | ---      | Зарезервировано |

#### 3. SMCR (Slave Mode Control Register)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | ECE      | External clock enable |
| 6   | ETP      | External trigger polarity |
| 5   | ETRF     | External trigger filter |
| 4   | ETPS     | External trigger prescaler |
| 3   | MSM      | Master/slave mode |
| 2-0 | TS       | Trigger selection |

#### 4. DIER (DMA/Interrupt Enable Register)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | TDE      | Trigger DMA enable |
| 6   | TCIE     | Trigger interrupt enable |
| 5   | UDE      | Update DMA enable |
| 4   | UIE      | Update interrupt enable |
| 3-0 | ---      | Зарезервировано |

#### 5. SR (Status Register)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | TIF      | Trigger interrupt flag |
| 6   | TIF      | Trigger interrupt flag |
| 5   | UIF      | Update interrupt flag |
| 4-0 | ---      | Зарезервировано |

#### 6. EGR (Event Generation Register)
| Бит | Название | Описание |
|-----|----------|----------|
| 7   | TG       | Trigger generation |
| 6   | TC       | Timer counter generation |
| 5   | UG       | Update generation |
| 4-0 | ---      | Зарезервировано |

#### 7. CNT (Counter Register)
- 16-битный регистр счетчика
- Читается/записывается как 16-битное значение
- При переполнении генерирует прерывание (если разрешено)

#### 8. PSC (Prescaler Register)
- 16-битный предделитель частоты
- Значение предделителя = PSC + 1
- Может использоваться для изменения частоты счета

#### 9. ARR (Auto Reload Register)
- 16-битный регистр автоматического перезагрузки
- При достижении значения генерируется событие переполнения
- Значение перезагрузки = ARR + 1

## Работа с TIM6

### Инициализация таймера:
1. Включить тактирование таймера
2. Настроить предделитель (PSC)
3. Установить значение перезагрузки (ARR)
4. Настроить режим работы (CR1)
5. Включить таймер (CEN)

### Пример инициализации:
```c
// Включение тактирования TIM6
RCC->APB1ENR |= RCC_APB1ENR_TIM6EN;

// Настройка предделителя (частота 1 кГц)
TIM6->PSC = 7199; // Предделитель 7200

// Настройка значения перезагрузки (1 секунда при 1 кГц)
TIM6->ARR = 999;

// Включение таймера
TIM6->CR1 |= TIM_CR1_CEN;
```

### Обработка прерываний:
1. Включить прерывание по обновлению (UIE)
2. Настроить обработчик прерывания
3. В обработчике очистить флаг прерывания ( UIF)

### Пример обработчика прерывания:
```c
void TIM6_IRQHandler(void) {
    if (TIM6->SR & TIM_SR_UIF) {
        // Обработка прерывания по обновлению
        TIM6->SR &= ~TIM_SR_UIF; // Очистка флага
        // Дополнительная логика
    }
}
```

## Режимы работы

### Режим счета:
- TIM6 работает как простой счетчик
- Счетчик увеличивается с каждым тактом
- При достижении значения ARR происходит переполнение

### Режим прерываний:
- При переполнении счетчика генерируется прерывание
- Прерывание можно разрешить/запретить через DIER
- Флаг прерывания устанавливается в SR

### Режим синхронизации:
- TIM6 может использоваться как мастер для синхронизации других таймеров
- Используется через SMCR и MMS

## Применение

### Часто используемое применение:
1. **Генерация периодических событий**
2. **Измерение временных интервалов**
3. **Создание задержек**
4. **Синхронизация с другими таймерами**

### Примеры использования:
- Создание системной задержки
- Измерение длительности импульсов
- Синхронизация с UART/USART
- Управление периодичностью опроса датчиков

## Особенности реализации в симуляторе

### Реализация в симуляторе STM32:
- **Регистры**: Все основные регистры TIM6 должны быть реализованы
- **Счетчик**: 16-битный счетчик с автоматической перезагрузкой
- **Прерывания**: Поддержка прерываний по обновлению
- **Предделитель**: Реализация предделителя частоты
- **Синхронизация**: Поддержка синхронизации с другими таймерами

### Требования к реализации:
1. Сохранение значений регистров при чтении/записи
2. Корректная работа с флагами прерываний
3. Соблюдение последовательности операций
4. Поддержка всех режимов работы
5. Синхронизация с системным таймером

## Рекомендации по использованию

### Рекомендации:
1. Использовать TIM6 для простых задач таймера
2. Не использовать для генерации PWM сигналов
3. Учитывать ограничения по частоте счета
4. Правильно настраивать предделитель для нужной частоты
5. Обязательно очищать флаги прерываний в обработчиках

### Ограничения:
- Нет выходных сигналов
- Ограниченные возможности синхронизации
- Только 16-битный счетчик
- Ограниченное количество функций по сравнению с TIM2-TIM5

## Заключение

TIM6 - это простой, но полезный таймер, который может быть использован для решения широкого круга задач встроенной разработки. Его простота делает его идеальным выбором для задач, где не требуется сложная генерация сигналов или многофункциональность. В симуляторе важно правильно реализовать все основные функции таймера для обеспечения совместимости с реальными микроконтроллерами.